#!/usr/bin/env bash

set -e

source $CONVENTION_ROOT/_lib/common.sh

# No PRE
[[ "$1" == "PRE" ]] && exit 0

# Expect POST
[[ "$1" == "POST" ]] || err "Got a parameter I don't understand: '$1'. Did the infrastructure change?"

# Add codecov configuration
echo "Copying .codecov.yml to your repository root."
cp ${HERE}/.codecov.yml $REPO_ROOT

# Add OWNERS_ALIASES to $REPO_ROOT
echo "Copying OWNERS_ALIASES to your repository root."
cp -L ${HERE}/OWNERS_ALIASES $REPO_ROOT

# Add CICD owners to .tekton if exists
if [[ -d "${REPO_ROOT}/.tekton/" ]]; then
	echo "Adding Konflux subdirectory OWNERS file to .tekton/"
	cat >"${REPO_ROOT}/.tekton/OWNERS" <<EOF
reviewers:
- srep-infra-cicd
approvers:
- srep-infra-cicd
EOF
fi

# Add dependabot configuration
mkdir -p $REPO_ROOT/.github
TARGET_FILE="${REPO_ROOT}/.github/dependabot.yml"
BOILERPLATE_FILE="${HERE}/dependabot.yml"

if [[ -f "$TARGET_FILE" ]]; then
  if grep -q '# BEGIN boilerplate-managed' "$TARGET_FILE"; then
    echo "Boilerplate-managed section already present in dependabot.yml, skipping append."
  elif diff -q "$TARGET_FILE" "$BOILERPLATE_FILE" >/dev/null; then
    echo "Wrapping existing dependabot.yml (which matches boilerplate) with boilerplate-managed markers..."
    mv "$TARGET_FILE" "${TARGET_FILE}.bak"
    {
      echo "# BEGIN boilerplate-managed"
      cat "${TARGET_FILE}.bak"
      echo "# END boilerplate-managed"
    } > "$TARGET_FILE"
    rm -f "${TARGET_FILE}.bak"
  else
    echo "[WARNING] dependabot.yml exists and differs from boilerplate template but has no boilerplate-managed markers."
    echo "[WARNING] Please review manually to avoid config duplication."
  fi
else
  echo "Copying boilerplate-managed dependabot.yml"
  cp "$BOILERPLATE_FILE" "$TARGET_FILE"
fi

# Add olm-registry Dockerfile
mkdir -p $REPO_ROOT/build
echo "Copying Dockerfile.olm-registry to build/Dockerfile.olm-registry"
cp ${HERE}/Dockerfile.olm-registry ${REPO_ROOT}/build/Dockerfile.olm-registry
# if the gitignore file exists, remove the olm-registry line
if [[ -f ${REPO_ROOT}/.gitignore ]]; then
  ${SED?} -i "/Dockerfile.olm-registry/d" ${REPO_ROOT}/.gitignore
fi

OPERATOR_NAME=$(sed -n 's/.*OperatorName .*"\([^"]*\)".*/\1/p' "${REPO_ROOT}/config/config.go")
OPERATOR_NAMESPACE=$(sed -n 's/.*OperatorNamespace .*"\([^"]*\)".*/\1/p' "${REPO_ROOT}/config/config.go")

if [[ ! -f ${REPO_ROOT}/config/metadata/additional-labels.txt ]]; then
  mkdir -p ${REPO_ROOT}/config/metadata
  cat >${REPO_ROOT}/config/metadata/additional-labels.txt <<EOF
LABEL com.redhat.component="openshift-${OPERATOR_NAME}" \
      io.k8s.description="..." \
      description="..." \
      distribution-scope="public" \
      name="openshift/${OPERATOR_NAME}" \
      url="https://github.com/openshift/${OPERATOR_NAME}" \
      vendor="Red Hat, Inc." \
      release="v0.0.0" \
      version="v0.0.0"
EOF
fi

IMAGE_PULL_PATH="quay.io/redhat-services-prod/openshift/boilerplate:${LATEST_IMAGE_TAG}"

# Update Dockerfile builder image
DOCKERFILES=$(ls -1 $REPO_ROOT/build/Dockerfile*)
for file in $DOCKERFILES; do
  # only update boilerplate base on the main file
  if [[ $file == *"Dockerfile" ]]; then
    echo "Overwriting $file's initial FROM with $IMAGE_PULL_PATH"
    ${SED?} -i "1s,.*,FROM $IMAGE_PULL_PATH AS builder," $file
  fi

  # Update any UBI images to use a versioned tag of ubi9/ubi-minimal that is compatible with dependabot.
  # WARNING: The ubi version _must_ match the one that Boilerplate's image is built with. Update this if you change the
  # base ubi version.
  UBI_IMAGE_NAME="registry.access.redhat.com/ubi9/ubi-minimal"
  for ubi_latest in $(grep -oE 'registry.access.redhat.com/ubi[7-9]/ubi.*?:.*' ${file}); do
      replacement_image=$(skopeo inspect --override-os linux --override-arch amd64 docker://${UBI_IMAGE_NAME} --format "{{.Name}}:{{.Labels.version}}-{{.Labels.release}}")
      echo "Overwriting ${file}'s ${ubi_latest} image to ${replacement_image}"
      ${SED?} -i "s,${ubi_latest},${replacement_image}," ${file}
  done
done

# Add ci-operator configuration
echo "Writing .ci-operator.yaml in your repository root with:"
echo "    namespace: $IMAGE_NAMESPACE"
echo "    name: $IMAGE_NAME"
echo "    tag: $LATEST_IMAGE_TAG"
${SED?} "s/__NAMESPACE__/$IMAGE_NAMESPACE/; s/__NAME__/$IMAGE_NAME/; s/__TAG__/$LATEST_IMAGE_TAG/" ${HERE}/.ci-operator.yaml >$REPO_ROOT/.ci-operator.yaml

# Check for pipeline files in .tekton directory and centralize them
TEKTON_DIR="${REPO_ROOT}/.tekton"
if [ -d "$TEKTON_DIR" ]; then
	for pipeline_file in "$TEKTON_DIR"/*.yaml; do
		if [ -f "$pipeline_file" ] && grep -q buildah "${pipeline_file}" && ! grep -q "pipelineRef:" "$pipeline_file"; then
			echo "Centralizing pipeline: $(basename "$pipeline_file")"
			python3 "${HERE}/migrate_build_pipeline.py" "${pipeline_file}"
		fi
	done
fi

# Konflux OLM Bundle and Catalog Support
echo "Setting up Konflux OLM bundle and catalog support..."

# Copy Containerfiles to repo root
echo "  Copying Containerfile.bundle and Containerfile.catalog..."
cp ${HERE}/Containerfile.bundle $REPO_ROOT/
cp ${HERE}/Containerfile.catalog $REPO_ROOT/

# Replace __OPERATOR_NAME__ placeholder in Containerfile.bundle
${SED?} -i "s/__OPERATOR_NAME__/${OPERATOR_NAME}/g" $REPO_ROOT/Containerfile.bundle

# Copy bundle-hack directory
echo "  Copying bundle-hack scripts..."
mkdir -p $REPO_ROOT/bundle-hack
cp -r ${HERE}/bundle-hack/* $REPO_ROOT/bundle-hack/
chmod +x $REPO_ROOT/bundle-hack/update_bundle.sh

# Replace __OPERATOR_NAME__ placeholder in bundle metadata generation
${SED?} -i "s/__OPERATOR_NAME__/${OPERATOR_NAME}/g" $REPO_ROOT/bundle-hack/update_bundle.sh

# Instantiate .tekton pipeline templates (only if .tekton directory exists)
if [[ -d "${REPO_ROOT}/.tekton/" && -n "${OPERATOR_NAME}" && -n "${OPERATOR_NAMESPACE}" ]]; then
  echo "  Generating Konflux OLM pipeline files..."

  # Instantiate each template
  for template in ${HERE}/.tekton-templates/*.yaml.tmpl; do
    if [[ -f "$template" ]]; then
      filename=$(basename "$template" .tmpl)
      output_file="${REPO_ROOT}/.tekton/${OPERATOR_NAME}-${filename}"

      # Replace placeholders
      ${SED?} -e "s/__OPERATOR_NAME__/${OPERATOR_NAME}/g" \
              -e "s/__NAMESPACE__/${OPERATOR_NAMESPACE}-tenant/g" \
              "$template" > "$output_file"

      echo "    Created ${OPERATOR_NAME}-${filename}"
    fi
  done
fi

# Create config/manifests directory if it doesn't exist
if [[ ! -d "${REPO_ROOT}/config/manifests" ]]; then
  echo "  Creating config/manifests directory..."
  mkdir -p $REPO_ROOT/config/manifests
  cp ${HERE}/config-templates/manifests/kustomization.yaml $REPO_ROOT/config/manifests/

  # Replace __OPERATOR_NAME__ placeholder
  ${SED?} -i "s/__OPERATOR_NAME__/${OPERATOR_NAME}/g" $REPO_ROOT/config/manifests/kustomization.yaml
fi

echo "Konflux OLM support configured successfully!"

cat <<EOF

=====================
THINGS YOU NEED TO DO
=====================
- Make sure the following line is in your base Makefile:

include boilerplate/generated-includes.mk

- Remove any other 'include' lines, unless they're for things truly
  unique to your repository. (Otherwise, consider proposing them to
  boilerplate.)

- Delete any obsolete files you're no longer including.

- Make sure you are properly integrated with codecov.io:
  https://github.com/openshift/ops-sop/blob/93d100347746ce04ad552591136818f82043c648/services/codecov.md#generate-the-codecovio-token

- Make sure your prow and app-sre pipeline configurations use the
  build_root configuration and standard targets described in the README.
=====================

EOF
